<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan 90 D√≠as ¬∑ Ingl√©s (A1‚ÜíA2)</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#101a33; --panel2:#0f1730; --card:#121f3f;
      --text:#e8edf8; --muted:#aab7d6; --muted2:#7f8db4;
      --line:rgba(255,255,255,.08);
      --accent:#64b5ff; --accent2:#7df7c8; --warn:#ffd166; --danger:#ff6b6b;
      --shadow:0 18px 45px rgba(0,0,0,.35);
      --radius:18px;
      --btn:#1a2a55;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:radial-gradient(1100px 600px at 30% -10%, #1c2a64 0%, rgba(28,42,100,0) 60%),
                 radial-gradient(800px 500px at 90% 0%, #0f6b6b 0%, rgba(15,107,107,0) 55%),
                 linear-gradient(180deg,var(--bg),#070a14);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1180px;margin:22px auto;padding:0 14px}
    .top{
      display:flex; align-items:flex-start; gap:14px; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      display:flex; gap:12px; align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      padding:14px 16px; border-radius:var(--radius); box-shadow:var(--shadow);
      min-width:min(720px, 100%);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .flag{font-size:16px}
    .h1{font-weight:800; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .nav{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px; border-radius:var(--radius);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
      font-size:13px;
    }
    .chip.active{
      background:rgba(100,181,255,.16);
      color:var(--text);
      border-color:rgba(100,181,255,.35);
    }

    .grid{display:grid; grid-template-columns:360px 1fr; gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .title{min-width:100%} }

    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .hd .h{font-weight:800}
    .tag{
      font-size:12px; color:var(--muted);
      padding:6px 9px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .bd{padding:12px 14px 14px}
    .note{
      padding:10px 12px; border-radius:14px;
      background:rgba(125,247,200,.10);
      border:1px solid rgba(125,247,200,.25);
      color:var(--text);
      font-size:13px;
    }
    .note b{color:var(--accent2)}
    .hr{height:1px;background:var(--line); margin:12px 0}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .input{
      width:100%;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:11px 12px;
      outline:none;
      font-size:14px;
    }
    .btn{
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      font-weight:750;
      font-size:13px;
    }
    .btn.primary{background:rgba(100,181,255,.18); border-color:rgba(100,181,255,.35)}
    .btn.good{background:rgba(125,247,200,.18); border-color:rgba(125,247,200,.35)}
    .btn.bad{background:rgba(255,107,107,.14); border-color:rgba(255,107,107,.30)}
    .btn:active{transform:translateY(1px)}
    .statgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .stat{
      padding:10px 12px; border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:900; margin-top:4px}
    .bar{
      height:10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      overflow:hidden;
    }
    .bar>div{height:100%; background:linear-gradient(90deg, var(--accent), var(--accent2)); width:0%}
    .small{font-size:12px;color:var(--muted)}
    .rightTitle{font-weight:900;font-size:16px}
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px 12px;
      margin-top:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:12px; color:var(--muted);
    }
    .badge b{color:var(--text)}
    .checkitem{
      display:flex; align-items:flex-start; gap:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      margin-top:10px;
    }
    .checkitem input{margin-top:4px; transform:scale(1.1)}
    .checkitem .t{font-weight:850}
    .checkitem .d{color:var(--muted); font-size:13px; margin-top:2px}
    .navDay{display:flex; gap:10px; justify-content:space-between; margin-top:12px}
    .navDay .btn{flex:1}
    .voiceBox{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .seg .label{font-size:12px;color:var(--muted); width:100%}
    .seg .opt{
      cursor:pointer;
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:750;
      font-size:12px;
    }
    .seg .opt.active{background:rgba(100,181,255,.18); border-color:rgba(100,181,255,.35); color:var(--text)}
    .phrase{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      margin-top:8px;
    }
    .phrase .en{font-weight:850}
    .phrase .es{color:var(--muted); font-size:12px; margin-top:2px}
    .iconbtn{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .icon{
      width:18px;height:18px;display:inline-block;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:20px; z-index:9999;
      background:rgba(16,26,51,.95);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.45);
      max-width:min(560px, 92vw);
      display:none;
      font-weight:700;
    }
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="pill"><span class="flag">üá∫üá∏</span><span class="flag">üáªüá™</span> Venezuela + USA (amistad)</div>
        <div>
          <div class="h1">Plan 90 D√≠as ¬∑ Ingl√©s (A1 ‚Üí A2)</div>
          <div class="sub">Checklist ¬∑ % Semana ¬∑ % General ¬∑ Puntos ¬∑ Voz (TTS) ¬∑ Invitaciones</div>
        </div>
      </div>

      <div class="nav">
        <button class="chip active" id="tabPlan" onclick="setTab('plan')">Plan</button>
        <button class="chip" id="tabInv" onclick="setTab('inv')">Invitaciones</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="hd">
          <div class="h">Acceso y progreso</div>
          <div class="tag"><b>Modo</b> <span id="modeText">Local</span></div>
        </div>
        <div class="bd">
          <div class="note" id="modeNote"><b>Modo local:</b> progreso guardado en este navegador (sin nube). No hay login.</div>

          <div class="hr"></div>

          <div class="small">Tu nombre (opcional, solo para mostrar en pantalla):</div>
          <input class="input" id="name" placeholder="Ej: Ernesto" />

          <div class="hr"></div>

          <div class="statgrid">
            <div class="stat">
              <div class="k">Semana actual</div>
              <div class="v" id="statWeek">1</div>
            </div>
            <div class="stat">
              <div class="k">D√≠a actual</div>
              <div class="v" id="statDay">1</div>
            </div>
            <div class="stat">
              <div class="k">% Semana</div>
              <div class="v" id="statWeekPct">0%</div>
              <div class="bar"><div id="barWeek"></div></div>
            </div>
            <div class="stat">
              <div class="k">% General</div>
              <div class="v" id="statAllPct">0%</div>
              <div class="bar"><div id="barAll"></div></div>
            </div>
            <div class="stat">
              <div class="k">Puntos</div>
              <div class="v" id="statPoints">0</div>
              <div class="small muted">+10 por tarea completada</div>
            </div>
            <div class="stat">
              <div class="k">‚ÄúCash‚Äù</div>
              <div class="v" id="statCash">0</div>
              <div class="small muted">+1 por tarea completada</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn" onclick="goDay(-1)">‚óÄ D√≠a anterior</button>
            <button class="btn primary" onclick="goDay(1)">D√≠a siguiente ‚ñ∂</button>
          </div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn" onclick="exportProgress()">Exportar progreso</button>
            <button class="btn" onclick="importProgress()">Importar</button>
            <button class="btn bad" onclick="resetProgress()">Reiniciar</button>
          </div>

          <div class="small muted" style="margin-top:8px">
            * En modo local, cada persona guarda su progreso en su propio dispositivo.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="hd">
          <div>
            <div class="rightTitle" id="rightTitle">Lecci√≥n ¬∑ D√≠a 1</div>
            <div class="sub" id="rightSub">Semana 1 ¬∑ Presentaci√≥n + Sonido TH</div>
          </div>
          <div class="tag">v4 ¬∑ local</div>
        </div>

        <div class="bd" id="rightBody">
          <!-- filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/*** ========= CONFIG (solo edita aqu√≠ 2 cosas) ========= ***/
const OWNER_NAME = "Ernesto"; // <- cambia si quieres
const INVITE_MESSAGE_DEFAULT =
`Hola üëã Soy Ernesto üá∫üá∏üáªüá™
Te invito a mi p√°gina ‚ÄúPlan 90 D√≠as de Ingl√©s (A1‚ÜíA2)‚Äù.
‚úÖ Es gratis y puedes avanzar a tu ritmo.

Abre el enlace aqu√≠:
{LINK}

(Sitio oficial)`;

/*** ========= APP STATE ========= ***/
const LS_KEY = "plan90_pro_local_v4";
const PLAN_DAYS = 90;
const TASK_POINTS = 10;
const TASK_CASH = 1;

const FALLBACK_BASE_URL = "https://proyecto-ernesto-ingles-2026.netlify.app"; // si est√°s offline (file://)
function getBaseUrl(){
  return (location.origin && location.origin.startsWith("http")) ? location.origin : FALLBACK_BASE_URL;
}

const state = {
  day: 1,
  name: OWNER_NAME,
  voiceMode: "auto", // auto | female | male
  rateMode: "normal", // lenta | normal | fluido
  progress: {}, // key: "d{day}:{taskId}" -> true
  points: 0,
  cash: 0,
  inviteCode: "",
};

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.style.display="none", 2600);
}

/*** ========= CURR√çCULO (auto-generado, 90 d√≠as) ========= ***/
const weeks = [
  { theme:"Presentaci√≥n + TH", sound:"TH (think/this)", grammar:"Pronombres + verbo 'to be' (I am / You are...)", vocab:["name","from","country","city","friend","nice","meet","today","English","Spanish","here","there"] },
  { theme:"N√∫meros + horas", sound:"V/W (very / water)", grammar:"There is / There are", vocab:["one","two","three","four","five","six","seven","eight","nine","ten","time","clock"] },
  { theme:"Rutina diaria", sound:"ED (worked)", grammar:"Presente simple (I work / I study)", vocab:["wake","work","study","eat","drink","drive","walk","sleep","morning","afternoon","night","always"] },
  { theme:"Compras", sound:"SH/CH", grammar:"Can / Can't (habilidad)", vocab:["store","price","cheap","expensive","cash","card","receipt","bag","need","want","buy","sell"] },
  { theme:"Direcciones", sound:"R/L", grammar:"Preposiciones (in/on/at)", vocab:["left","right","straight","near","far","street","road","corner","map","between","next","behind"] },
  { theme:"Comida", sound:"B/P", grammar:"Contables e incontables (some/any)", vocab:["bread","milk","water","rice","chicken","fish","fruit","vegetables","salt","sugar","hungry","thirsty"] },
  { theme:"Salud", sound:"S/Z", grammar:"Should (consejo)", vocab:["doctor","pain","headache","medicine","rest","sleep","exercise","healthy","sick","better","worse","strong"] },
  { theme:"Trabajo", sound:"T/D", grammar:"Pasado simple (did / went)", vocab:["job","boss","team","schedule","tools","safety","quality","report","meeting","project","problem","solution"] },
  { theme:"Viajes", sound:"Y/J", grammar:"Futuro con going to", vocab:["trip","airport","ticket","hotel","passport","luggage","plane","train","reservation","visit","tour","travel"] },
  { theme:"Familia", sound:"N/NG", grammar:"Have/Has got", vocab:["family","mother","father","brother","sister","son","daughter","married","single","kids","home","love"] },
  { theme:"Clima", sound:"K/G", grammar:"Comparativos (bigger, colder)", vocab:["weather","cold","hot","rain","snow","wind","cloudy","sunny","storm","forecast","coat","boots"] },
  { theme:"Conversaci√≥n real", sound:"F/H", grammar:"Preguntas WH (what/where/when/why/how)", vocab:["what","where","when","why","how","who","which","because","maybe","sure","again","repeat"] },
  { theme:"Repaso + Fluidez", sound:"Mixed", grammar:"Repaso general A1‚ÜíA2", vocab:["review","practice","improve","focus","repeat","shadowing","progress","goal","plan","daily","simple","solid"] },
];

const tasksTemplate = [
  { id:"pron", title:"Pronunciaci√≥n (10 repeticiones)", desc:"Practica el sonido foco del d√≠a. Haz 3 rondas: 1) lento 2) normal 3) shadowing." },
  { id:"vocab", title:"Vocabulario (12 palabras)", desc:"Aprende 12 palabras del tema y √∫salas en 4 frases." },
  { id:"gram", title:"Gram√°tica (10 min)", desc:"Regla del tema + 6 ejemplos (hablados y escritos)." },
  { id:"speak", title:"Speaking (5 min)", desc:"Responde 10 preguntas cortas en voz alta (sin leer al final)." },
  { id:"read", title:"Listening/Reading", desc:"Lee un texto corto y repite 6 frases como eco (shadowing)." },
];

function dayInfo(day){
  const w = Math.floor((day-1)/7)+1;
  const week = weeks[Math.min(w-1, weeks.length-1)];
  const dayInWeek = ((day-1)%7)+1;

  // mini-variaci√≥n por d√≠a
  const focus = (dayInWeek<=2) ? "b√°sico" : (dayInWeek<=5 ? "pr√°ctica" : "repaso");
  const phraseSet = makePhrases(week, dayInWeek);

  return {
    day, week: w,
    title: `D√≠a ${day} ¬∑ Semana ${w}: ${week.theme}`,
    sub: `Pronunciaci√≥n: ${week.sound} ¬∑ Gram√°tica: ${week.grammar}`,
    weekTheme: week.theme,
    sound: week.sound,
    grammar: week.grammar,
    vocab: week.vocab,
    focus,
    phrases: phraseSet
  };
}

function makePhrases(week, dayInWeek){
  // 6 frases por d√≠a (EN + ES)
  const base = [
    ["Hi, my name is Ernesto.", "Hola, mi nombre es Ernesto."],
    ["I am from Venezuela and I live in the USA.", "Soy de Venezuela y vivo en EE.UU."],
    ["Nice to meet you.", "Mucho gusto."],
    ["I am learning English every day.", "Estoy aprendiendo ingl√©s todos los d√≠as."],
    ["Can you repeat, please?", "¬øPuedes repetir, por favor?"],
    ["Thank you! See you tomorrow.", "¬°Gracias! Te veo ma√±ana."],
  ];

  // Ajuste por tema (cambia algunas frases para que se sienta distinto)
  const t = week.theme.toLowerCase();
  if(t.includes("compras")){
    return [
      ["How much is this?", "¬øCu√°nto cuesta esto?"],
      ["I want to buy this, please.", "Quiero comprar esto, por favor."],
      ["Do you accept card?", "¬øAceptan tarjeta?"],
      ["That is too expensive.", "Eso est√° muy caro."],
      ["I need a receipt, please.", "Necesito un recibo, por favor."],
      ["Thank you. Have a nice day!", "Gracias. ¬°Que tengas buen d√≠a!"],
    ];
  }
  if(t.includes("direcciones")){
    return [
      ["Excuse me, where is the street?", "Disculpa, ¬ød√≥nde est√° la calle?"],
      ["Go straight and turn left.", "Sigue derecho y gira a la izquierda."],
      ["It is next to the bank.", "Est√° al lado del banco."],
      ["Is it far from here?", "¬øEst√° lejos de aqu√≠?"],
      ["I am using the map.", "Estoy usando el mapa."],
      ["Thank you for your help!", "¬°Gracias por tu ayuda!"],
    ];
  }
  if(t.includes("salud")){
    return [
      ["I have a headache.", "Tengo dolor de cabeza."],
      ["I need some rest.", "Necesito descansar."],
      ["You should drink water.", "Deber√≠as tomar agua."],
      ["I feel better today.", "Me siento mejor hoy."],
      ["This medicine helps me.", "Esta medicina me ayuda."],
      ["Thank you, doctor.", "Gracias, doctor."],
    ];
  }
  if(t.includes("viajes")){
    return [
      ["I am going to travel next week.", "Voy a viajar la pr√≥xima semana."],
      ["I have a ticket and a passport.", "Tengo un boleto y un pasaporte."],
      ["Where is the airport?", "¬øD√≥nde est√° el aeropuerto?"],
      ["I need a hotel reservation.", "Necesito una reserva de hotel."],
      ["My luggage is heavy.", "Mi equipaje est√° pesado."],
      ["I am excited for the trip!", "¬°Estoy emocionado por el viaje!"],
    ];
  }
  // ligera rotaci√≥n
  if(dayInWeek>=6){
    return base.slice().reverse();
  }
  return base;
}

/*** ========= STORAGE ========= ***/
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return;
  try{
    const o = JSON.parse(raw);
    if(o && typeof o === "object"){
      Object.assign(state, o);
      state.day = clamp(parseInt(state.day||1,10),1,PLAN_DAYS);
      state.progress = state.progress || {};
      state.points = state.points || 0;
      state.cash = state.cash || 0;
      state.voiceMode = state.voiceMode || "auto";
      state.rateMode = state.rateMode || "normal";
      state.inviteCode = state.inviteCode || "";
      state.name = state.name || OWNER_NAME;
    }
  }catch(e){}
}

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

/*** ========= UI ========= ***/
function setTab(tab){
  document.getElementById("tabPlan").classList.toggle("active", tab==="plan");
  document.getElementById("tabInv").classList.toggle("active", tab==="inv");
  if(tab==="plan") renderPlan();
  else renderInvitations();
}

function goDay(delta){
  state.day = clamp(state.day + delta, 1, PLAN_DAYS);
  save();
  renderPlan();
}

function taskKey(day, taskId){ return `d${day}:${taskId}`; }

function toggleTask(day, taskId, checked){
  const k = taskKey(day, taskId);
  const prev = !!state.progress[k];
  state.progress[k] = !!checked;

  if(!prev && checked){
    state.points += TASK_POINTS;
    state.cash += TASK_CASH;
  }
  if(prev && !checked){
    state.points = Math.max(0, state.points - TASK_POINTS);
    state.cash = Math.max(0, state.cash - TASK_CASH);
  }
  save();
  updateStats();
}

function computeStats(){
  const totalTasks = PLAN_DAYS * tasksTemplate.length;
  let done = 0;

  const info = dayInfo(state.day);
  const weekStart = (info.week-1)*7 + 1;
  const weekEnd = Math.min(PLAN_DAYS, weekStart + 6);
  let weekTotal = (weekEnd - weekStart + 1) * tasksTemplate.length;
  let weekDone = 0;

  for(const k in state.progress){
    if(state.progress[k]) done++;
    if(state.progress[k]){
      const m = k.match(/^d(\d+):/);
      if(m){
        const d = parseInt(m[1],10);
        if(d>=weekStart && d<=weekEnd) weekDone++;
      }
    }
  }

  const allPct = totalTasks ? Math.round((done/totalTasks)*100) : 0;
  const weekPct = weekTotal ? Math.round((weekDone/weekTotal)*100) : 0;

  return {totalTasks, done, allPct, weekPct, weekStart, weekEnd};
}

function updateStats(){
  const info = dayInfo(state.day);
  const s = computeStats();

  document.getElementById("statWeek").textContent = info.week;
  document.getElementById("statDay").textContent = info.day;
  document.getElementById("statWeekPct").textContent = s.weekPct + "%";
  document.getElementById("statAllPct").textContent = s.allPct + "%";
  document.getElementById("barWeek").style.width = s.weekPct + "%";
  document.getElementById("barAll").style.width = s.allPct + "%";
  document.getElementById("statPoints").textContent = state.points;
  document.getElementById("statCash").textContent = state.cash;

  document.getElementById("rightTitle").textContent = `Lecci√≥n ¬∑ D√≠a ${info.day}`;
  document.getElementById("rightSub").textContent = `Semana ${info.week} ¬∑ ${info.weekTheme}`;
}

function renderPlan(){
  updateStats();

  const info = dayInfo(state.day);
  const body = document.getElementById("rightBody");
  body.innerHTML = "";

  // Voice controls
  const voiceWrap = document.createElement("div");
  voiceWrap.className = "seg";
  voiceWrap.innerHTML = `
    <div class="label">Voz y velocidad</div>
    <div class="row" style="width:100%">
      <span class="badge"><b>Modo de voz:</b> <span class="muted">${state.voiceMode}</span></span>
      <span class="badge"><b>Velocidad:</b> <span class="muted">${state.rateMode}</span></span>
    </div>
    <div class="row">
      <button class="opt ${state.voiceMode==='female'?'active':''}" onclick="setVoiceMode('female')">Femenina</button>
      <button class="opt ${state.voiceMode==='male'?'active':''}" onclick="setVoiceMode('male')">Masculina</button>
      <button class="opt ${state.voiceMode==='auto'?'active':''}" onclick="setVoiceMode('auto')">Auto</button>
    </div>
    <div class="row">
      <button class="opt ${state.rateMode==='lenta'?'active':''}" onclick="setRate('lenta')">Lenta</button>
      <button class="opt ${state.rateMode==='normal'?'active':''}" onclick="setRate('normal')">Normal</button>
      <button class="opt ${state.rateMode==='fluido'?'active':''}" onclick="setRate('fluido')">Fluido</button>
    </div>
  `;
  body.appendChild(voiceWrap);

  // Mini lesson
  const mini = document.createElement("div");
  mini.className = "card";
  mini.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div class="rightTitle">Mini-lecci√≥n</div>
      <span class="badge"><b>Duraci√≥n:</b> <span class="muted">60 min</span></span>
    </div>
    <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap">
      <span class="badge"><b>Pronunciaci√≥n:</b> <span class="muted">${info.sound}</span></span>
      <span class="badge"><b>Tema:</b> <span class="muted">${info.weekTheme}</span></span>
      <span class="badge"><b>Gram√°tica:</b> <span class="muted">${info.grammar}</span></span>
    </div>
    <div class="hr"></div>
    <div class="small muted">Vocabulario del tema (12):</div>
    <div class="mono" style="margin-top:6px; color:var(--text)">${info.vocab.join(" ¬∑ ")}</div>
  `;
  body.appendChild(mini);

  // Checklist
  const chk = document.createElement("div");
  chk.className = "card";
  chk.innerHTML = `<div class="rightTitle">Checklist <span class="muted" style="font-size:13px;font-weight:700">marca al terminar</span></div>`;
  tasksTemplate.forEach(t=>{
    const checked = !!state.progress[taskKey(info.day, t.id)];
    const item = document.createElement("div");
    item.className = "checkitem";
    item.innerHTML = `
      <input type="checkbox" ${checked?'checked':''} onchange="toggleTask(${info.day}, '${t.id}', this.checked)" />
      <div>
        <div class="t">${t.title}</div>
        <div class="d">${t.desc}</div>
      </div>
    `;
    chk.appendChild(item);
  });
  body.appendChild(chk);

  // Phrases + TTS
  const ph = document.createElement("div");
  ph.className = "card";
  ph.innerHTML = `<div class="rightTitle">Frases del d√≠a (con voz)</div>
                  <div class="sub">Haz shadowing: escucha ‚Üí repite ‚Üí imita ritmo y entonaci√≥n.</div>`;
  info.phrases.forEach(([en,es])=>{
    const row = document.createElement("div");
    row.className = "phrase";
    row.innerHTML = `
      <div>
        <div class="en">${en}</div>
        <div class="es">${es}</div>
      </div>
      <button class="btn primary" onclick="speak(${JSON.stringify(en)})">üîä</button>
    `;
    ph.appendChild(row);
  });
  body.appendChild(ph);

  // Bottom day nav
  const nav = document.createElement("div");
  nav.className = "navDay";
  nav.innerHTML = `
    <button class="btn" onclick="goDay(-1)">‚óÄ D√≠a anterior</button>
    <button class="btn primary" onclick="goDay(1)">D√≠a siguiente ‚ñ∂</button>
  `;
  body.appendChild(nav);
}

function renderInvitations(){
  updateStats();
  const body = document.getElementById("rightBody");
  const base = getBaseUrl();

  // ensure invite code exists for owner
  if(!state.inviteCode){
    state.inviteCode = generateInviteCode();
    save();
  }
  const link = `${base}/?invite=${state.inviteCode}`;
  const msg = INVITE_MESSAGE_DEFAULT.replace("{LINK}", link);

  body.innerHTML = `
    <div class="card">
      <div class="rightTitle">Invitaciones</div>
      <div class="sub">En modo local no hay login. Simplemente comparte el link. Cada persona guarda su progreso en su dispositivo.</div>

      <div class="hr"></div>

      <div class="small muted">C√≥digo de invitaci√≥n:</div>
      <div class="row" style="margin-top:8px">
        <span class="badge"><b class="mono">${state.inviteCode}</b></span>
        <button class="btn" onclick="newInvite()">Generar nuevo</button>
      </div>

      <div class="hr"></div>

      <div class="small muted">Link:</div>
      <div class="mono" style="margin-top:6px; word-break:break-all">${link}</div>

      <div class="hr"></div>

      <div class="small muted">Tu mensaje (se env√≠a con el link):</div>
      <textarea class="input" id="inviteMsg" style="min-height:150px; margin-top:8px">${escapeHtml(msg)}</textarea>

      <div class="hr"></div>

      <div class="row">
        ${shareButton("WhatsApp", iconWhatsApp(), "wa", msg)}
        ${shareButton("Telegram", iconTelegram(), "tg", msg)}
        ${shareButton("X", iconX(), "x", msg)}
        ${shareButton("Email", iconMail(), "mail", msg)}
        <button class="iconbtn" onclick="copyInvite()">${iconCopy()} Copiar</button>
      </div>

      <div class="hr"></div>

      <div class="note">
        <b>Tip:</b> abre el enlace una vez en tu tel√©fono, as√≠ verificas que funciona antes de enviarlo a mucha gente.
      </div>
    </div>
  `;

  // put real text into textarea (escapeHtml used only to avoid breaking HTML)
  const ta = document.getElementById("inviteMsg");
  ta.value = msg;
}

function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/*** ========= INVITE / SHARE ========= ***/
function generateInviteCode(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let out = "";
  for(let i=0;i<8;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}
function newInvite(){
  state.inviteCode = generateInviteCode();
  save();
  renderInvitations();
  toast("Nuevo c√≥digo creado: " + state.inviteCode);
}

function copyInvite(){
  const ta = document.getElementById("inviteMsg");
  const text = ta.value;
  navigator.clipboard?.writeText(text).then(()=>{
    toast("Mensaje copiado ‚úÖ");
  }).catch(()=>{
    // fallback
    ta.select();
    document.execCommand("copy");
    toast("Mensaje copiado ‚úÖ");
  });
}

function shareButton(label, svg, kind, msg){
  return `<button class="iconbtn" onclick="share('${kind}')">${svg} ${label}</button>`;
}
function share(kind){
  const ta = document.getElementById("inviteMsg");
  const text = (ta && ta.value) ? ta.value : "";
  const base = getBaseUrl();
  const link = `${base}/?invite=${state.inviteCode}`;
  const enc = encodeURIComponent(text.replace("{LINK}", link));

  let url = "";
  if(kind==="wa"){
    url = "https://wa.me/?text=" + enc;
  }else if(kind==="tg"){
    // telegram comparte url + texto; mandamos todo como texto
    url = "https://t.me/share/url?url=" + encodeURIComponent(link) + "&text=" + encodeURIComponent(text);
  }else if(kind==="x"){
    url = "https://twitter.com/intent/tweet?text=" + enc;
  }else if(kind==="mail"){
    const subject = encodeURIComponent("Invitaci√≥n: Plan 90 D√≠as de Ingl√©s (A1‚ÜíA2)");
    url = "mailto:?subject=" + subject + "&body=" + enc;
  }
  window.open(url, "_blank");
}

/*** ========= ICONS (inline SVG) ========= ***/
function iconWhatsApp(){ return `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M20.5 11.9c0 4.7-3.9 8.6-8.6 8.6-1.5 0-2.9-.4-4.2-1l-3.2.9.9-3.1c-.7-1.3-1.1-2.8-1.1-4.4 0-4.7 3.9-8.6 8.6-8.6s8.6 3.9 8.6 8.6Z" stroke="currentColor" stroke-width="1.6"/><path d="M9.2 8.7c.2-.3.4-.3.6-.3h.5c.1 0 .3 0 .4.3l.7 1.6c.1.3.1.5 0 .7l-.4.5c-.1.2-.1.3 0 .5.3.6 1 1.3 1.6 1.6.2.1.3.1.5 0l.5-.4c.2-.1.4-.1.7 0l1.6.7c.2.1.3.3.3.4v.5c0 .2 0 .4-.3.6-.4.4-1 .8-1.7.8-1.5 0-3.3-1-4.6-2.3S7.8 10.3 7.8 8.8c0-.7.4-1.3.8-1.7Z" fill="currentColor"/></svg>`; }
function iconTelegram(){ return `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M20.7 4.7 3.8 11.2c-.8.3-.8 1.4 0 1.7l4.2 1.4 1.6 4.9c.2.7 1.1.8 1.6.3l2.4-2.4 4.8 3.5c.6.4 1.4.1 1.6-.6l3-14.3c.2-.9-.7-1.6-1.5-1.3Z" stroke="currentColor" stroke-width="1.6"/><path d="M8 14.3 18.2 7.6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`; }
function iconX(){ return `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M7 5h4l6 14h-4L7 5Z" stroke="currentColor" stroke-width="1.6"/><path d="M17 5h-3.5L7 19h3.5L17 5Z" fill="currentColor" opacity=".35"/></svg>`; }
function iconMail(){ return `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4.5 7.2A2.2 2.2 0 0 1 6.7 5h10.6a2.2 2.2 0 0 1 2.2 2.2v9.6a2.2 2.2 0 0 1-2.2 2.2H6.7a2.2 2.2 0 0 1-2.2-2.2V7.2Z" stroke="currentColor" stroke-width="1.6"/><path d="m5.3 7.4 6.1 5c.4.3.9.3 1.3 0l6.1-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`; }
function iconCopy(){ return `<svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M8 8h10v12H8V8Z" stroke="currentColor" stroke-width="1.6"/><path d="M6 16H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="1.6"/></svg>`; }

/*** ========= TTS (voz) ========= ***/
function setVoiceMode(m){ state.voiceMode=m; save(); renderPlan(); }
function setRate(m){ state.rateMode=m; save(); renderPlan(); }

function pickRate(){
  if(state.rateMode==="lenta") return 0.85;
  if(state.rateMode==="fluido") return 1.05;
  return 0.95;
}

function speak(text){
  try{
    if(!("speechSynthesis" in window)){
      toast("Tu navegador no soporta voz (TTS).");
      return;
    }
    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = pickRate();

    const voices = window.speechSynthesis.getVoices() || [];
    // intenta elegir una voz de ingl√©s
    const enVoices = voices.filter(v => (v.lang||"").toLowerCase().startsWith("en"));
    let chosen = null;

    if(state.voiceMode==="female"){
      chosen = enVoices.find(v => /female|zira|susan|aria|jenny/i.test(v.name)) || enVoices[0];
    }else if(state.voiceMode==="male"){
      chosen = enVoices.find(v => /male|david|mark|guy/i.test(v.name)) || enVoices[0];
    }else{
      chosen = enVoices[0] || voices[0];
    }
    if(chosen) u.voice = chosen;

    window.speechSynthesis.speak(u);
  }catch(e){
    toast("No se pudo reproducir voz.");
  }
}
// en algunos navegadores, getVoices carga tarde
if("speechSynthesis" in window){
  window.speechSynthesis.onvoiceschanged = ()=>{};
}

/*** ========= BACKUP / RESET ========= ***/
function exportProgress(){
  const data = JSON.stringify(state, null, 2);
  navigator.clipboard?.writeText(data).then(()=>{
    toast("Progreso exportado (copiado) ‚úÖ");
  }).catch(()=>{
    prompt("Copia este texto:", data);
  });
}
function importProgress(){
  const txt = prompt("Pega aqu√≠ el texto exportado:");
  if(!txt) return;
  try{
    const o = JSON.parse(txt);
    if(!o || typeof o!=="object") throw new Error("bad");
    Object.assign(state, o);
    state.day = clamp(parseInt(state.day||1,10),1,PLAN_DAYS);
    state.progress = state.progress || {};
    state.points = state.points || 0;
    state.cash = state.cash || 0;
    state.inviteCode = state.inviteCode || "";
    save();
    toast("Importado ‚úÖ");
    renderPlan();
  }catch(e){
    toast("Texto inv√°lido.");
  }
}
function resetProgress(){
  if(!confirm("¬øSeguro que quieres reiniciar TODO tu progreso local?")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

/*** ========= INIT ========= ***/
function applyInviteFromUrl(){
  const p = new URLSearchParams(location.search);
  const inv = (p.get("invite")||"").trim().toUpperCase();
  if(inv && /^[A-Z0-9]{6,12}$/.test(inv)){
    // para el invitado, guardamos ese c√≥digo (solo informativo)
    state.inviteCode = inv;
    save();
  }
}

function init(){
  load();
  applyInviteFromUrl();

  document.getElementById("name").value = state.name || "";
  document.getElementById("name").addEventListener("input", (e)=>{
    state.name = (e.target.value||"").trim();
    save();
  });

  renderPlan();
}
init();
</script>
</body>
</html>

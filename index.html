<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan 90 D√≠as ¬∑ Ingl√©s (A1‚ÜíA2)</title>
  <meta name="description" content="Curso A1‚ÜíA2 en 90 d√≠as. Progreso personal en este dispositivo. Invitaci√≥n controlada por el administrador." />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --panel2:#0c172b;
      --text:#e9eefb; --muted:#a8b3d6; --line:#22304d;
      --acc:#4aa3ff; --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --btn:#122449; --btn2:#0c1c3a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1100px 600px at 20% 10%, rgba(74,163,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(74,222,128,.12), transparent 60%),
                  radial-gradient(900px 500px at 40% 95%, rgba(251,191,36,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--acc); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px 40px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:10px 12px; border:1px solid var(--line); border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, rgba(74,163,255,.8), rgba(74,222,128,.55));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
    }
    .title{display:flex; flex-direction:column}
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title .sub{color:var(--muted); font-size:12.5px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      padding:7px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); color:var(--muted); font-size:13px;
      cursor:pointer; user-select:none;
    }
    .chip.active{background: rgba(74,163,255,.16); color:var(--text); border-color: rgba(74,163,255,.4)}
    .chip.badge{cursor:default}
    .grid{display:grid; grid-template-columns: 330px 1fr; gap:14px; margin-top:14px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .panel{
      border:1px solid var(--line); border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .ph{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:10px}
    .ph .h{font-weight:650}
    .ph .mini{color:var(--muted); font-size:12px}
    .pb{padding:14px}
    .note{
      padding:10px 12px; border:1px dashed rgba(74,163,255,.35);
      background: rgba(74,163,255,.08); border-radius:12px; color:var(--text);
      line-height:1.35;
    }
    .warn{
      border-color: rgba(251,191,36,.4);
      background: rgba(251,191,36,.10);
    }
    .ok{border-color: rgba(74,222,128,.35); background: rgba(74,222,128,.10)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(10,20,42,.65); color:var(--text);
      outline:none;
    }
    .input:focus{border-color: rgba(74,163,255,.55); box-shadow:0 0 0 3px rgba(74,163,255,.12)}
    .btn{
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      color:var(--text); cursor:pointer; user-select:none;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
    }
    .btn:hover{border-color: rgba(74,163,255,.5)}
    .btn.primary{background: rgba(74,163,255,.18); border-color: rgba(74,163,255,.45)}
    .btn.good{background: rgba(74,222,128,.15); border-color: rgba(74,222,128,.35)}
    .btn.bad{background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.35)}
    .btn.small{padding:7px 10px; border-radius:10px; font-size:13px}
    .hr{height:1px; background: var(--line); margin:12px 0}
    .statgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .stat{
      border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02);
      padding:10px 12px;
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-size:18px; font-weight:700; margin-top:2px}
    .pill{
      padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
      color:var(--muted); font-size:12px;
    }
    .lesson h2{margin:0 0 8px; font-size:18px}
    .lesson .meta{color:var(--muted); font-size:12.5px; margin-bottom:10px}
    .section{margin:12px 0; padding:12px; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02)}
    .section .sh{font-weight:700; margin-bottom:8px; display:flex; justify-content:space-between; gap:10px; align-items:center}
    .list{margin:0; padding-left:18px; line-height:1.45}
    .chk{display:flex; gap:10px; align-items:flex-start; margin:8px 0}
    .chk input{margin-top:3px; transform: scale(1.1)}
    .muted{color:var(--muted)}
    .kbd{font-family:var(--mono); font-size:12px; padding:2px 6px; border-radius:8px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12)}
    .sharegrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
    @media (max-width: 520px){ .sharegrid{grid-template-columns:1fr} }
    .linkbox{
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background: rgba(10,20,42,.65); font-family:var(--mono); font-size:12.5px; word-break:break-all;
    }
    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background: rgba(12,23,43,.95); border:1px solid rgba(255,255,255,.14);
      color:var(--text); padding:10px 12px; border-radius:12px;
      box-shadow: var(--shadow); display:none; max-width:min(720px, calc(100% - 24px));
    }
    .smallprint{font-size:12px; color:var(--muted); line-height:1.4}
    .spinner{
      width:14px; height:14px; border:2px solid rgba(255,255,255,.2);
      border-top-color: rgba(74,163,255,.9); border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Plan 90 D√≠as ¬∑ Ingl√©s (A1 ‚Üí A2)</h1>
          <div class="sub">Modo Local (gratis) ¬∑ Invitaci√≥n controlada ¬∑ Progreso guardado en tu dispositivo</div>
        </div>
      </div>

      <div class="chips">
        <span class="chip badge" id="modeChip">Modo: <b id="modeText">Cargando...</b></span>
        <span class="chip" id="tabPlan">Plan</span>
        <span class="chip" id="tabInvite">Invitaciones</span>
        <span class="chip" id="tabHelp">Ayuda</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="ph">
          <div>
            <div class="h">Cuenta y progreso</div>
            <div class="mini">Beta</div>
          </div>
          <span class="pill" id="unlockPill">üîí Bloqueado</span>
        </div>
        <div class="pb">
          <div id="unlockBox" class="note warn">
            <b>Necesitas una invitaci√≥n</b><br/>
            Pega tu c√≥digo o abre un enlace que termine en <span class="kbd">?invite=XXXX</span>.
            <div class="hr"></div>
            <input class="input" id="inviteInput" placeholder="Pega aqu√≠ tu c√≥digo de invitaci√≥n" />
            <div style="height:10px"></div>
            <div class="row">
              <button class="btn primary" id="btnUnlock">Desbloquear</button>
              <button class="btn" id="btnClearInvite">Borrar</button>
            </div>
            <div style="height:8px"></div>
            <div class="smallprint">Esto es para controlar la difusi√≥n. El progreso es personal (se guarda en tu navegador / iPhone).</div>
          </div>

          <div id="progressBox" style="display:none">
            <div class="note ok" id="deviceNote">
              ‚úÖ <b>Acceso activo.</b> Tu progreso se guarda en este dispositivo.
            </div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between; gap:10px">
              <div style="min-width:140px; flex:1">
                <div class="muted" style="font-size:12px">D√≠a actual</div>
                <input class="input" id="dayInput" type="number" min="1" max="90" />
              </div>
              <div style="min-width:140px; flex:1">
                <div class="muted" style="font-size:12px">Semana</div>
                <div class="input" id="weekLabel" style="display:flex; align-items:center"></div>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="row">
              <button class="btn small" id="btnPrev">‚óÄ D√≠a</button>
              <button class="btn small" id="btnToday">Ir al d√≠a</button>
              <button class="btn small" id="btnNext">D√≠a ‚ñ∂</button>
              <span class="pill" id="savePill">Guardado</span>
            </div>

            <div class="hr"></div>
            <div class="statgrid">
              <div class="stat">
                <div class="k">Completadas</div>
                <div class="v" id="doneCount">0</div>
              </div>
              <div class="stat">
                <div class="k">Porcentaje</div>
                <div class="v" id="donePct">0%</div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="row">
              <button class="btn bad small" id="btnResetDay">Reiniciar d√≠a</button>
              <button class="btn bad small" id="btnResetAll">Reiniciar TODO</button>
            </div>

            <div style="height:8px"></div>
            <div class="smallprint">
              Consejo: en iPhone, si no se guarda, abre en Safari (no dentro de WhatsApp) y permite almacenamiento.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="ph">
          <div>
            <div class="h" id="rightTitle">Plan</div>
            <div class="mini" id="rightMini">Cargando‚Ä¶</div>
          </div>
          <div class="row">
            <button class="btn small" id="btnSpeak" title="Leer en voz alta el objetivo del d√≠a">üîä Voz</button>
            <button class="btn small" id="btnHardRefresh" title="Recargar sin cach√©">‚Üª Recargar</button>
          </div>
        </div>
        <div class="pb" id="rightBody"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ============================================================
   CONFIG F√ÅCIL (solo cambia aqu√≠ si lo deseas)
   ============================================================ */
const APP_NAME = "plan90_local_beta";
const PLAN_DAYS = 90;

// IMPORTANTE:
// Para GitHub Pages, tu sitio NO es la ra√≠z del usuario, sino del repositorio.
// Ejemplo: https://ernesto2026pro.github.io/plan90D-ingles/
// Puedes dejarlo vac√≠o y el sistema lo detecta (recomendado).
const PUBLIC_BASE_URL = ""; // ejemplo: "https://ernesto2026pro.github.io/plan90D-ingles/"

// PIN ADMIN (para que solo T√ö puedas crear invitaciones).
// C√°mbialo por uno tuyo (4-8 d√≠gitos). No lo compartas.
const ADMIN_PIN = "2026";

// Texto que va en el mensaje de invitaci√≥n:
const INVITE_MESSAGE_DEFAULT =
`Hola üëã Soy Ernesto üáªüá™üá∫üá∏
Te invito a mi p√°gina ‚ÄúPlan 90 D√≠as de Ingl√©s (A1‚ÜíA2)‚Äù.
‚úÖ Es gratis y puedes avanzar a tu ritmo.

Dame tu opini√≥n, es importante para la mejora continua.
Si gustas, puedes colaborar con una donaci√≥n (opcional).

Abre el enlace aqu√≠:
{LINK}

(Sitio oficial)`;

// Donaciones (opcional). Si no tienes enlaces, d√©jalos vac√≠os.
const DONATE_LINKS = [
  // { label:"Patreon $10", url:"https://patreon.com/tu_usuario?..." },
  // { label:"PayPal", url:"https://paypal.me/tu_usuario" }
];

/* ============================================================
   UTILIDADES
   ============================================================ */
const LS_KEY = (k)=> `${APP_NAME}:${k}`;
const $ = (id)=> document.getElementById(id);

function toast(msg, ms=2600){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", ms);
}

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function baseUrl(){
  if(PUBLIC_BASE_URL && PUBLIC_BASE_URL.trim()){
    let u = PUBLIC_BASE_URL.trim();
    if(!u.endsWith("/")) u += "/";
    return u;
  }
  // Auto-detect (incluye la ruta del repo en GitHub Pages)
  let path = window.location.pathname || "/";
  // si termina en index.html, quitar el archivo
  path = path.replace(/\/[^\/]*\.(html?)$/i, "/");
  if(!path.endsWith("/")) path += "/";
  return window.location.origin + path;
}

function openExternal(url){
  window.open(url, "_blank", "noopener,noreferrer");
}

// Web Speech API (voz). Requiere interacci√≥n del usuario.
function speak(text){
  try{
    if(!("speechSynthesis" in window)) { toast("Tu navegador no soporta voz."); return; }
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    u.pitch = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch(e){
    toast("No se pudo reproducir la voz.");
  }
}

// hash simple para validar invitaciones (evita que otros inventen c√≥digos f√°cilmente)
function simpleHash(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h>>>0).toString(36).toUpperCase();
}

function generateInviteCode(){
  const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // sin 0/O/1/I
  let payload = "";
  for(let i=0;i<6;i++) payload += alphabet[Math.floor(Math.random()*alphabet.length)];
  const sig = simpleHash(ADMIN_PIN + "|" + payload).slice(0,3);
  return payload + sig; // 9 chars
}

function validateInviteCode(code){
  const c = (code||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
  if(c.length !== 9) return false;
  const payload = c.slice(0,6);
  const sig = c.slice(6,9);
  const expected = simpleHash(ADMIN_PIN + "|" + payload).slice(0,3);
  return sig === expected;
}

/* ============================================================
   CURR√çCULO 90 D√çAS (generado)
   ============================================================ */
const WEEKS = [
  { theme:"Saludos y presentaciones", focus:["Hola/Adi√≥s","Nombre y pa√≠s","Cortes√≠a","N√∫meros 1‚Äì20","Deletreo","D√≠as de la semana","Repaso"] },
  { theme:"Familia y descripciones", focus:["Familia","Adjetivos","Colores","Edad","Objetos","Preguntas b√°sicas","Repaso"] },
  { theme:"Rutinas y tiempo", focus:["Rutina diaria","Horas","Frecuencia","Hobbies","Clima","Planes simples","Repaso"] },
  { theme:"Comida y compras", focus:["Comidas","Restaurante","Supermercado","Precios","Preferencias","Cocina","Repaso"] },
  { theme:"Ciudad y direcciones", focus:["Lugares","Direcciones","Transporte","Mapas","Emergencias","Servicios","Repaso"] },
  { theme:"Trabajo y habilidades", focus:["Profesiones","Tareas","Herramientas","Correo/llamadas","Reuniones","Permisos","Repaso"] },
  { theme:"Salud y bienestar", focus:["S√≠ntomas","Farmacia","Citas","Ejercicio","Dieta","Consejos","Repaso"] },
  { theme:"Pasado simple (A2)", focus:["Ayer","Viajes","Historias","Irregulars 1","Irregulars 2","Preguntas pasado","Repaso"] },
  { theme:"Futuro y planes", focus:["Going to","Fechas","Objetivos","Invitaciones","Reservas","Promesas","Repaso"] },
  { theme:"Opiniones y comparaciones", focus:["Me gusta","Comparativos","Recomendaciones","Problemas","Soluciones","Acuerdos","Repaso"] },
  { theme:"Situaciones reales", focus:["Hotel","Restaurante avanzado","Trabajo avanzado","Compras online","Soporte t√©cnico","Imprevistos","Repaso"] },
  { theme:"Consolidaci√≥n y proyecto", focus:["Proyecto 1","Proyecto 2","Presentaci√≥n","Entrevista","Pitch","Examen","Repaso final"] },
  { theme:"Cierre", focus:["Repaso A1","Repaso A2","Plan siguiente","Celebraci√≥n","Feedback","Donaci√≥n opcional","Fin"] }
];

const VOCAB_SETS = {
  greetings:["hello","hi","good morning","good afternoon","good evening","goodbye","see you","please","thank you","you're welcome"],
  family:["mother","father","sister","brother","wife","husband","son","daughter","family","friends"],
  routine:["wake up","go to work","have breakfast","study","exercise","cook","watch TV","go to bed","every day","sometimes"],
  food:["water","coffee","tea","bread","rice","chicken","fish","salad","fruit","vegetables"],
  city:["street","avenue","corner","left","right","straight","near","far","bus","train"],
  work:["job","team","meeting","deadline","tools","report","email","call","schedule","project"],
  health:["headache","fever","cough","pain","medicine","pharmacy","doctor","appointment","healthy","tired"],
  past:["yesterday","last week","ago","went","saw","did","had","came","took","made"],
  future:["tomorrow","next week","plan","going to","will","maybe","soon","later","appointment","reservation"],
  opinion:["I think","I prefer","better","worse","more","less","because","in my opinion","I agree","I disagree"]
};

function pick(arr, n){
  const a = arr.slice();
  const out = [];
  while(out.length<n && a.length){
    out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]);
  }
  return out;
}

function dayInfo(day){
  const week = Math.floor((day-1)/7) + 1;
  const within = (day-1)%7; // 0..6
  const w = WEEKS[clamp(week,1,WEEKS.length)-1];
  const focus = w.focus[within] || "Pr√°ctica";
  const theme = w.theme;

  // vocab base por tema
  let base = VOCAB_SETS.greetings;
  if(theme.includes("Familia")) base = VOCAB_SETS.family;
  else if(theme.includes("Rutinas")) base = VOCAB_SETS.routine;
  else if(theme.includes("Comida")) base = VOCAB_SETS.food;
  else if(theme.includes("Ciudad")) base = VOCAB_SETS.city;
  else if(theme.includes("Trabajo")) base = VOCAB_SETS.work;
  else if(theme.includes("Salud")) base = VOCAB_SETS.health;
  else if(theme.includes("Pasado")) base = VOCAB_SETS.past;
  else if(theme.includes("Futuro")) base = VOCAB_SETS.future;
  else if(theme.includes("Opiniones")) base = VOCAB_SETS.opinion;

  const vocab = pick(base, 8);
  const phrases = makePhrases(theme, focus);

  return {day, week, theme, focus, vocab, phrases};
}

function makePhrases(theme, focus){
  // 5 frases EN + traducci√≥n ES
  const p = [];
  function add(en, es){ p.push({en, es}); }
  // Greetings
  if(theme.includes("Saludos")){
    add("Hi! My name is Ernesto.", "¬°Hola! Mi nombre es Ernesto.");
    add("Nice to meet you.", "Mucho gusto.");
    add("Where are you from?", "¬øDe d√≥nde eres?");
    add("I‚Äôm from Venezuela.", "Soy de Venezuela.");
    add("See you later!", "¬°Nos vemos luego!");
    return p;
  }
  if(theme.includes("Familia")){
    add("This is my family.", "Esta es mi familia.");
    add("My sister is very kind.", "Mi hermana es muy amable.");
    add("How old are you?", "¬øCu√°ntos a√±os tienes?");
    add("I‚Äôm sixty-six years old.", "Tengo sesenta y seis a√±os.");
    add("He is tall and friendly.", "√âl es alto y amigable.");
    return p;
  }
  if(theme.includes("Rutinas")){
    add("I wake up at 6:30 a.m.", "Me despierto a las 6:30 a. m.");
    add("I study English every day.", "Estudio ingl√©s todos los d√≠as.");
    add("I usually have coffee.", "Normalmente tomo caf√©.");
    add("What time is it?", "¬øQu√© hora es?");
    add("Let‚Äôs practice for 10 minutes.", "Practiquemos 10 minutos.");
    return p;
  }
  if(theme.includes("Comida")){
    add("I‚Äôd like a chicken salad, please.", "Quisiera una ensalada de pollo, por favor.");
    add("How much is this?", "¬øCu√°nto cuesta esto?");
    add("Can I pay by card?", "¬øPuedo pagar con tarjeta?");
    add("I‚Äôm allergic to peanuts.", "Soy al√©rgico al man√≠.");
    add("That‚Äôs delicious!", "¬°Eso est√° delicioso!");
    return p;
  }
  if(theme.includes("Ciudad")){
    add("Excuse me, where is the bus stop?", "Disculpe, ¬ød√≥nde est√° la parada de autob√∫s?");
    add("Go straight and turn left.", "Siga recto y gire a la izquierda.");
    add("It‚Äôs next to the bank.", "Est√° al lado del banco.");
    add("How far is it?", "¬øQu√© tan lejos est√°?");
    add("I need help, please.", "Necesito ayuda, por favor.");
    return p;
  }
  if(theme.includes("Trabajo")){
    add("I work as a tax preparer.", "Trabajo como preparador de impuestos.");
    add("Let‚Äôs schedule a meeting.", "Agendemos una reuni√≥n.");
    add("Please send me an email.", "Por favor env√≠ame un correo.");
    add("I‚Äôm working on a project.", "Estoy trabajando en un proyecto.");
    add("We finished on time.", "Terminamos a tiempo.");
    return p;
  }
  if(theme.includes("Salud")){
    add("I have a headache.", "Me duele la cabeza.");
    add("I need an appointment.", "Necesito una cita.");
    add("Take this medicine once a day.", "Tome este medicamento una vez al d√≠a.");
    add("Do you have any allergies?", "¬øTiene alergias?");
    add("I feel better today.", "Me siento mejor hoy.");
    return p;
  }
  if(theme.includes("Pasado")){
    add("Yesterday I worked all day.", "Ayer trabaj√© todo el d√≠a.");
    add("I went to the store.", "Fui a la tienda.");
    add("I saw my friend.", "Vi a mi amigo.");
    add("Did you study yesterday?", "¬øEstudiaste ayer?");
    add("Yes, I did.", "S√≠, lo hice.");
    return p;
  }
  if(theme.includes("Futuro")){
    add("I‚Äôm going to study tonight.", "Voy a estudiar esta noche.");
    add("We‚Äôre going to travel next month.", "Vamos a viajar el pr√≥ximo mes.");
    add("I will call you later.", "Te llamar√© m√°s tarde.");
    add("Do you want to join us?", "¬øQuieres unirte?");
    add("Let‚Äôs meet tomorrow.", "Nos vemos ma√±ana.");
    return p;
  }
  if(theme.includes("Opiniones")){
    add("I think this is better.", "Creo que esto es mejor.");
    add("In my opinion, it‚Äôs important.", "En mi opini√≥n, es importante.");
    add("I prefer coffee to tea.", "Prefiero caf√© a t√©.");
    add("I agree with you.", "Estoy de acuerdo contigo.");
    add("I disagree, but it‚Äôs okay.", "No estoy de acuerdo, pero est√° bien.");
    return p;
  }
  // default
  add("Today‚Äôs focus is: " + focus + ".", "El enfoque de hoy es: " + focus + ".");
  add("Repeat after me.", "Repite despu√©s de m√≠.");
  add("Let‚Äôs do a short practice.", "Hagamos una pr√°ctica corta.");
  add("Great job!", "¬°Buen trabajo!");
  add("See you tomorrow!", "¬°Nos vemos ma√±ana!");
  return p;
}

function tasksForDay(d){
  // 6 tareas simples
  return [
    {id:"listen", label:"Escucha / lee las 5 frases y repite 2 veces."},
    {id:"vocab", label:"Aprende 8 palabras (mira vocabulario)."},
    {id:"speak", label:"Usa el bot√≥n üîä y repite con voz clara."},
    {id:"write", label:"Escribe 3 oraciones con el tema de hoy."},
    {id:"quiz", label:"Haz el mini-quiz (auto-evaluaci√≥n)."},
    {id:"review", label:"Repasa el d√≠a anterior 3 minutos."},
  ];
}

/* ============================================================
   ESTADO Y ALMACENAMIENTO
   ============================================================ */
const state = {
  unlocked:false,
  day:1,
  progress:{}, // progress[day] = { taskId:true, notes:"" }
  adminSession:false
};

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY("state"));
    if(raw){
      const o = JSON.parse(raw);
      state.day = clamp(parseInt(o.day||1,10),1,PLAN_DAYS);
      state.progress = o.progress || {};
      state.unlocked = !!o.unlocked;
      state.adminSession = !!o.adminSession;
    }
  }catch(e){}
}

function saveState(){
  localStorage.setItem(LS_KEY("state"), JSON.stringify({
    day: state.day,
    progress: state.progress,
    unlocked: state.unlocked,
    adminSession: state.adminSession
  }));
  $("savePill").textContent = "Guardado";
  clearTimeout(saveState._t);
  saveState._t = setTimeout(()=> $("savePill").textContent="OK", 900);
}

function resetDay(){
  delete state.progress[String(state.day)];
  saveState();
  render();
  toast("D√≠a reiniciado.");
}

function resetAll(){
  if(!confirm("¬øSeguro? Se borrar√° TODO tu progreso en este dispositivo.")) return;
  localStorage.removeItem(LS_KEY("state"));
  state.day = 1;
  state.progress = {};
  state.unlocked = false;
  state.adminSession = false;
  render();
  toast("Todo reiniciado.");
}

/* ============================================================
   DESBLOQUEO POR INVITACI√ìN
   ============================================================ */
function unlockWithCode(code){
  if(!validateInviteCode(code)){
    toast("C√≥digo inv√°lido. Revisa y vuelve a intentar.");
    return false;
  }
  state.unlocked = true;
  saveState();
  setUnlockUI(true);
  toast("¬°Listo! Acceso activado.");
  return true;
}

function setUnlockUI(unlocked){
  $("unlockBox").style.display = unlocked ? "none" : "block";
  $("progressBox").style.display = unlocked ? "block" : "none";
  $("unlockPill").textContent = unlocked ? "üîì Activo" : "üîí Bloqueado";
}

/* ============================================================
   UI: Tabs
   ============================================================ */
let activeTab = "plan";
function setTab(tab){
  activeTab = tab;
  ["plan","invite","help"].forEach(t=>{
    const el = t==="plan"?$("tabPlan") : t==="invite"?$("tabInvite") : $("tabHelp");
    el.classList.toggle("active", tab===t);
  });
  renderRight();
}

function weekForDay(day){ return Math.floor((day-1)/7) + 1; }

function computeCompletion(){
  let done=0, total=0;
  for(let d=1; d<=PLAN_DAYS; d++){
    const t = tasksForDay(d);
    total += t.length;
    const p = state.progress[String(d)] || {};
    for(const task of t){
      if(p[task.id]) done++;
    }
  }
  const pct = total ? Math.round((done/total)*100) : 0;
  return {done,total,pct};
}

/* ============================================================
   RENDER
   ============================================================ */
function renderLeft(){
  $("modeText").textContent = "Local";
  $("rightMini").textContent = state.unlocked ? "Listo" : "Bloqueado";
  setUnlockUI(state.unlocked);

  // Day input & stats
  $("dayInput").value = state.day;
  $("dayInput").disabled = !state.unlocked;

  const wk = weekForDay(state.day);
  $("weekLabel").textContent = "Semana " + wk;
  $("btnPrev").disabled = !state.unlocked;
  $("btnNext").disabled = !state.unlocked;
  $("btnToday").disabled = !state.unlocked;
  $("btnResetDay").disabled = !state.unlocked;
  $("btnResetAll").disabled = !state.unlocked;

  const c = computeCompletion();
  $("doneCount").textContent = `${c.done}/${c.total}`;
  $("donePct").textContent = `${c.pct}%`;
}

function renderPlanTab(){
  const info = dayInfo(state.day);
  const tasks = tasksForDay(state.day);
  const p = state.progress[String(state.day)] || {};
  const lines = [];

  lines.push(`<div class="lesson">
    <h2>D√≠a ${info.day} ¬∑ ${info.theme}</h2>
    <div class="meta">Semana ${info.week} ¬∑ Enfoque: <b>${info.focus}</b></div>
  </div>`);

  // Objective
  lines.push(`<div class="section">
    <div class="sh">üéØ Objetivo del d√≠a <span class="pill">A1‚ÜíA2</span></div>
    <div class="muted">Entender y usar frases cortas relacionadas con <b>${info.theme}</b>, practicando <b>${info.focus}</b>.</div>
  </div>`);

  // Vocabulary
  lines.push(`<div class="section">
    <div class="sh">üìö Vocabulario (8)</div>
    <ul class="list">${info.vocab.map(w=>`<li><b>${w}</b></li>`).join("")}</ul>
  </div>`);

  // Phrases with TTS buttons
  lines.push(`<div class="section">
    <div class="sh">üó£Ô∏è Frases clave (5) <span class="pill">Toca üîä</span></div>
    ${info.phrases.map((x,i)=>`
      <div style="margin:8px 0; padding:10px 10px; border:1px solid var(--line); border-radius:12px; background: rgba(255,255,255,.02)">
        <div class="row" style="justify-content:space-between">
          <div style="flex:1">
            <div><b>${i+1}. ${x.en}</b></div>
            <div class="muted">${x.es}</div>
          </div>
          <button class="btn small" data-say="${encodeURIComponent(x.en)}">üîä</button>
        </div>
      </div>
    `).join("")}
  </div>`);

  // Tasks checklist
  lines.push(`<div class="section">
    <div class="sh">‚úÖ Tareas (marca al completar)</div>
    ${tasks.map(t=>`
      <label class="chk">
        <input type="checkbox" data-task="${t.id}" ${p[t.id] ? "checked":""} />
        <span>${t.label}</span>
      </label>
    `).join("")}
    <div class="hr"></div>
    <div class="muted">Notas del d√≠a (opcional)</div>
    <textarea class="input" id="notes" rows="3" placeholder="Escribe aqu√≠ tus notas...">${(p.notes||"")}</textarea>
  </div>`);

  // Mini quiz
  const q = makeQuiz(info);
  lines.push(`<div class="section">
    <div class="sh">üß© Mini-quiz (auto)</div>
    <div class="muted">${q.prompt}</div>
    <div style="height:10px"></div>
    <div class="row">
      ${q.options.map(opt=>`<button class="btn small" data-quiz="${encodeURIComponent(opt)}">${opt}</button>`).join("")}
    </div>
    <div style="height:10px"></div>
    <div class="note" id="quizResult" style="display:none"></div>
  </div>`);

  $("rightBody").innerHTML = lines.join("\n");

  // Bind events inside plan tab
  // TTS buttons
  $("rightBody").querySelectorAll("button[data-say]").forEach(b=>{
    b.addEventListener("click", ()=> speak(decodeURIComponent(b.dataset.say)));
  });

  // Task checkboxes
  $("rightBody").querySelectorAll("input[data-task]").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const dkey = String(state.day);
      state.progress[dkey] = state.progress[dkey] || {};
      state.progress[dkey][cb.dataset.task] = cb.checked;
      saveState();
      renderLeft();
    });
  });

  // Notes
  const notes = $("notes");
  notes.addEventListener("input", ()=>{
    const dkey = String(state.day);
    state.progress[dkey] = state.progress[dkey] || {};
    state.progress[dkey].notes = notes.value;
    saveState();
  });

  // Quiz
  $("rightBody").querySelectorAll("button[data-quiz]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const ans = decodeURIComponent(btn.dataset.quiz);
      const ok = ans === q.answer;
      const box = $("quizResult");
      box.style.display = "block";
      box.className = "note " + (ok ? "ok" : "warn");
      box.innerHTML = ok
        ? `‚úÖ Correcto. <b>${q.answer}</b>`
        : `‚ö†Ô∏è Casi. La respuesta correcta es: <b>${q.answer}</b>`;
      // marcar tarea quiz autom√°ticamente si acierta
      if(ok){
        const dkey = String(state.day);
        state.progress[dkey] = state.progress[dkey] || {};
        state.progress[dkey].quiz = true;
        saveState();
        renderLeft();
      }
    });
  });
}

function makeQuiz(info){
  // pregunta simple: traducci√≥n de una palabra del vocab
  const word = info.vocab[0] || "hello";
  const pairs = {
    "hello":"hola","hi":"hola","good morning":"buenos d√≠as","goodbye":"adi√≥s","please":"por favor","thank you":"gracias",
    "mother":"madre","father":"padre","sister":"hermana","brother":"hermano","family":"familia","friends":"amigos",
    "wake up":"despertarse","study":"estudiar","every day":"todos los d√≠as","sometimes":"a veces",
    "water":"agua","coffee":"caf√©","bread":"pan","rice":"arroz","chicken":"pollo",
    "street":"calle","left":"izquierda","right":"derecha","near":"cerca","far":"lejos",
    "job":"trabajo","meeting":"reuni√≥n","email":"correo","project":"proyecto",
    "headache":"dolor de cabeza","fever":"fiebre","medicine":"medicina","doctor":"doctor",
    "yesterday":"ayer","went":"fui","saw":"vi","did":"hice","had":"tuve",
    "tomorrow":"ma√±ana","plan":"plan","going to":"voy a",
    "I think":"yo creo","better":"mejor","because":"porque"
  };
  const answer = pairs[word] || "traducci√≥n";
  const options = pick([answer,"opci√≥n 2","opci√≥n 3","opci√≥n 4"].map(x=>x), 4);
  // asegurar que answer est√© incluido
  if(!options.includes(answer)) options[Math.floor(Math.random()*options.length)] = answer;
  // barajar
  options.sort(()=>Math.random()-0.5);

  return {
    prompt:`¬øQu√© significa ‚Äú${word}‚Äù en espa√±ol?`,
    options,
    answer
  };
}

function renderInviteTab(){
  // Admin gate
  const lines = [];
  lines.push(`<div class="lesson">
    <h2>Invitaciones</h2>
    <div class="meta">Solo el administrador (t√∫) puede crear invitaciones.</div>
  </div>`);

  lines.push(`<div class="section">
    <div class="sh">üîê Acceso Admin</div>
    <div class="muted">Ingresa tu PIN para habilitar el panel de invitaciones en este dispositivo.</div>
    <div style="height:10px"></div>
    <div class="row">
      <input class="input" id="adminPin" type="password" inputmode="numeric" placeholder="PIN admin" style="max-width:220px"/>
      <button class="btn primary" id="btnAdmin">Entrar</button>
      <button class="btn" id="btnAdminOut">Salir</button>
    </div>
    <div style="height:10px"></div>
    <div class="smallprint">Tip: No compartas tu PIN. Esto es control local (sin servidor) para evitar difusi√≥n.</div>
  </div>`);

  if(state.adminSession){
    const code = generateInviteCode();
    const link = baseUrl() + "?invite=" + encodeURIComponent(code);
    const msg = INVITE_MESSAGE_DEFAULT.replace("{LINK}", link);

    lines.push(`<div class="section">
      <div class="sh">‚ûï Crear invitaci√≥n (1 uso)</div>
      <div class="muted">C√≥digo generado:</div>
      <div class="linkbox" id="inviteCodeBox">${code}</div>
      <div style="height:10px"></div>
      <div class="muted">Enlace:</div>
      <div class="linkbox" id="inviteLinkBox">${link}</div>
      <div style="height:10px"></div>
      <div class="muted">Mensaje (puedes copiar y pegar):</div>
      <div class="linkbox" id="inviteMsgBox">${escapeHtml(msg)}</div>

      <div class="hr"></div>
      <div class="sharegrid">
        <button class="btn good" id="btnCopyLink">üìã Copiar enlace</button>
        <button class="btn" id="btnCopyMsg">üìã Copiar mensaje</button>
        <button class="btn" id="btnWA">üü¢ WhatsApp</button>
        <button class="btn" id="btnTG">‚úàÔ∏è Telegram</button>
        <button class="btn" id="btnX">ùïè X</button>
        <button class="btn" id="btnEmail">‚úâÔ∏è Email</button>
      </div>

      <div style="height:10px"></div>
      <button class="btn primary" id="btnNewCode">Generar otro c√≥digo</button>
    </div>`);

    if(DONATE_LINKS.length){
      lines.push(`<div class="section">
        <div class="sh">üíõ Donaciones (opcional)</div>
        <div class="muted">Selecciona un monto o plataforma:</div>
        <div style="height:10px"></div>
        <div class="row">
          ${DONATE_LINKS.map(x=>`<button class="btn" data-donate="${encodeURIComponent(x.url)}">${escapeHtml(x.label)}</button>`).join("")}
        </div>
      </div>`);
    }
  } else {
    lines.push(`<div class="note warn">
      üîí Panel de invitaciones desactivado. Ingresa tu PIN arriba para crear invitaciones.
    </div>`);
  }

  $("rightBody").innerHTML = lines.join("\n");

  // Bind admin actions
  const pin = $("adminPin");
  const btnAdmin = $("btnAdmin");
  const btnOut = $("btnAdminOut");
  btnAdmin.addEventListener("click", ()=>{
    if((pin.value||"").trim() === ADMIN_PIN){
      state.adminSession = true;
      saveState();
      toast("Admin activado.");
      renderRight();
    }else{
      toast("PIN incorrecto.");
    }
    pin.value = "";
  });
  btnOut.addEventListener("click", ()=>{
    state.adminSession = false;
    saveState();
    toast("Admin desactivado.");
    renderRight();
  });

  if(!state.adminSession) return;

  // share / copy
  const link = $("inviteLinkBox").textContent;
  const msg = $("inviteMsgBox").textContent;

  $("btnCopyLink").addEventListener("click", async ()=>{
    await copyText(link);
    toast("Enlace copiado.");
  });
  $("btnCopyMsg").addEventListener("click", async ()=>{
    await copyText(msg);
    toast("Mensaje copiado.");
  });

  $("btnWA").addEventListener("click", ()=>{
    openExternal("https://wa.me/?text=" + encodeURIComponent(msg));
  });
  $("btnTG").addEventListener("click", ()=>{
    openExternal("https://t.me/share/url?url=" + encodeURIComponent(link) + "&text=" + encodeURIComponent(msg));
  });
  $("btnX").addEventListener("click", ()=>{
    openExternal("https://twitter.com/intent/tweet?text=" + encodeURIComponent(msg));
  });
  $("btnEmail").addEventListener("click", ()=>{
    openExternal("mailto:?subject=" + encodeURIComponent("Invitaci√≥n ¬∑ Plan 90 D√≠as Ingl√©s") + "&body=" + encodeURIComponent(msg));
  });

  const btnNew = $("btnNewCode");
  btnNew.addEventListener("click", ()=> renderRight());

  // donate buttons
  $("rightBody").querySelectorAll("button[data-donate]").forEach(b=>{
    b.addEventListener("click", ()=> openExternal(decodeURIComponent(b.dataset.donate)));
  });
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
  }
}

function escapeHtml(str){
  return (str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function renderHelpTab(){
  const lines = [];
  lines.push(`<div class="lesson">
    <h2>Ayuda r√°pida</h2>
    <div class="meta">Soluciones a los problemas m√°s comunes.</div>
  </div>`);

  lines.push(`<div class="section">
    <div class="sh">üì± iPhone abre y sale 404</div>
    <div class="muted">
      Eso pasa cuando el enlace NO incluye el nombre del repositorio.<br/>
      ‚úÖ El enlace correcto debe verse as√≠:
      <div class="linkbox">${escapeHtml(baseUrl())}?invite=CODIGO</div>
      Si te sale algo como <span class="kbd">https://ernesto2026pro.github.io/?invite=...</span> est√° mal.
    </div>
  </div>`);

  lines.push(`<div class="section">
    <div class="sh">üéß No suena el audio</div>
    <div class="muted">
      El bot√≥n üîä usa la voz del navegador. En iPhone necesitas tocar el bot√≥n (no reproduce solo).<br/>
      Si est√°s dentro de WhatsApp, abre el enlace en Safari con ‚ÄúAbrir en navegador‚Äù.
    </div>
  </div>`);

  lines.push(`<div class="section">
    <div class="sh">üê¢ La laptop se pone lenta</div>
    <div class="muted">
      Prueba: <b>Ctrl+Shift+R</b> para recargar sin cach√©, cierra pesta√±as, y reinicia Chrome.<br/>
      Si sigue lento, desactiva extensiones o prueba otro navegador.
    </div>
  </div>`);

  lines.push(`<div class="section">
    <div class="sh">üîÑ ¬øPuedo agregar contenido sin perder progreso?</div>
    <div class="muted">
      S√≠. El progreso se guarda por d√≠a y por tarea en el dispositivo. Si agregas m√°s contenido, no borra lo ya marcado.
      (Solo se perder√≠a si cambias el nombre de la app <span class="kbd">APP_NAME</span> o si el usuario borra el historial del navegador).
    </div>
  </div>`);

  lines.push(`<div class="note">
    <b>Ruta del sitio (GitHub Pages)</b><br/>
    Tu URL de proyecto es: <span class="kbd">https://TUUSUARIO.github.io/NOMBRE_REPO/</span><br/>
    Si cambias el nombre del repo, cambia la URL.
  </div>`);

  $("rightBody").innerHTML = lines.join("\n");
}

function renderRight(){
  $("rightTitle").textContent = activeTab === "plan" ? "Plan" : (activeTab === "invite" ? "Invitaciones" : "Ayuda");
  if(!state.unlocked && activeTab === "plan"){
    $("rightBody").innerHTML = `<div class="note warn">
      üîí El plan est√° bloqueado. Ve a <b>Cuenta y progreso</b> y pega tu c√≥digo de invitaci√≥n.
    </div>`;
    return;
  }
  if(activeTab === "plan") renderPlanTab();
  if(activeTab === "invite") renderInviteTab();
  if(activeTab === "help") renderHelpTab();
}

function render(){
  renderLeft();
  renderRight();
}

/* ============================================================
   EVENTOS
   ============================================================ */
function bindStaticEvents(){
  $("tabPlan").addEventListener("click", ()=> setTab("plan"));
  $("tabInvite").addEventListener("click", ()=> setTab("invite"));
  $("tabHelp").addEventListener("click", ()=> setTab("help"));

  $("btnUnlock").addEventListener("click", ()=>{
    unlockWithCode($("inviteInput").value);
  });
  $("btnClearInvite").addEventListener("click", ()=>{
    $("inviteInput").value = "";
    toast("Campo borrado.");
  });

  $("dayInput").addEventListener("change", ()=>{
    state.day = clamp(parseInt($("dayInput").value||"1",10),1,PLAN_DAYS);
    saveState();
    render();
  });

  $("btnPrev").addEventListener("click", ()=>{
    state.day = clamp(state.day-1,1,PLAN_DAYS);
    saveState(); render();
  });
  $("btnNext").addEventListener("click", ()=>{
    state.day = clamp(state.day+1,1,PLAN_DAYS);
    saveState(); render();
  });
  $("btnToday").addEventListener("click", ()=>{
    // aqu√≠ "Ir al d√≠a" solo refresca el render
    render();
    toast("Listo.");
  });

  $("btnResetDay").addEventListener("click", resetDay);
  $("btnResetAll").addEventListener("click", resetAll);

  $("btnHardRefresh").addEventListener("click", ()=>{
    toast("Recargando‚Ä¶");
    window.location.reload(true);
  });

  $("btnSpeak").addEventListener("click", ()=>{
    const info = dayInfo(state.day);
    speak(`Day ${info.day}. ${info.theme}. Focus: ${info.focus}.`);
  });
}

function applyInviteFromUrl(){
  const params = new URLSearchParams(window.location.search);
  const invite = params.get("invite");
  if(invite){
    // limpiar URL (sin recargar)
    try{
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, "", clean);
    }catch(e){}
    if(unlockWithCode(invite)){
      setTab("plan");
    }
  }
}

/* ============================================================
   INIT
   ============================================================ */
(function init(){
  bindStaticEvents();
  loadState();
  applyInviteFromUrl();
  setUnlockUI(state.unlocked);
  setTab("plan");
  render();
})();
</script>
</body>
</html>
